<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Recuperación de Contraseña - Paso 2</title>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="css/StyleLogin.css" /> 
</head>
<body>
    <div id="login-container">
        <h2 style="margin-bottom: 0.5rem;">Recuperación de Contraseña</h2>
        <h3 style="font-weight: 400; font-size: 1.2rem; margin-bottom: 1.5rem;">2. Código de Seguridad</h3>
        <form id="verifyCodeForm">
            <p style="text-align: left; margin-bottom: 1rem;">
                Para continuar, ingresa el código de seguridad de 6 dígitos que hemos enviado a tu correo. El código expira en 15 minutos.
            </p>
            
            <label for="code">Ingresa tu Código de Seguridad:</label>
            <input 
                type="text" 
                id="code" 
                name="code" 
                pattern="\d{6}" 
                maxlength="6" 
                required 
                title="El código debe ser de 6 dígitos numéricos."
            ><br><br>
            
            <div id="message" style="color: red; margin-bottom: 15px;"></div>
            
            <div style="text-align: right; margin-bottom: 15px; font-size: 0.9em;">
                ¿No has recibido el código? <a href="reset_password.html" style="color: var(--primary); text-decoration: none;">Solicitar uno nuevo</a>
            </div>

            <button type="submit" id="validateButton">Validar</button>
        </form>
    </div>

    <script>
        const API_URL_VERIFY = 'https://raw-philipa-odvin123-8a860263.koyeb.app/api/validar-reset-code'; 
        const verifyCodeForm = document.getElementById('verifyCodeForm');
        const messageDisplay = document.getElementById('message');
        const validateButton = document.getElementById('validateButton');
        let tenantId = ''; 
        let email = '';

        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            tenantId = urlParams.get('tenant');
            email = urlParams.get('email');
            
            if (!tenantId || !email) {
                messageDisplay.style.color = 'red';
                messageDisplay.textContent = 'Error: Faltan datos de usuario. Por favor, vuelva a la página anterior.';
                validateButton.disabled = true;
            }
        });

        verifyCodeForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            messageDisplay.textContent = '';
            validateButton.disabled = true;
            validateButton.textContent = 'Verificando...';

            const code = document.getElementById('code').value;
            const data = { tenant_id: tenantId, correo_electronico: email, token_code: code };

            try {
                const response = await fetch(API_URL_VERIFY, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    messageDisplay.style.color = 'green';
                    messageDisplay.textContent = 'Código verificado con éxito. Redirigiendo al paso 3...';
          
                    setTimeout(() => {
                        window.location.href = `reset_password_final.html?resetToken=${result.resetToken}`;
                    }, 1500);

                } else {
                    messageDisplay.style.color = 'red';
                    messageDisplay.textContent = result.message || 'Error: El código es incorrecto o ha expirado.';
                }
            } catch (e) {
                messageDisplay.style.color = 'red';
                messageDisplay.textContent = 'Error de conexión con el servidor.';
            } finally {
                validateButton.disabled = false;
                validateButton.textContent = 'Validar';
            }
        });
    </script>
</body>
</html>