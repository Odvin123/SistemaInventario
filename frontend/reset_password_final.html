<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Recuperación de Contraseña - Paso 3</title>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="css/StyleLogin.css" />
</head>
<body>
    <div id="login-container">
        <h2 style="margin-bottom: 0.5rem;">Recuperación de Contraseña</h2>
        <h3 style="font-weight: 400; font-size: 1.2rem; margin-bottom: 1.5rem;">3. Nueva Contraseña</h3>
        <form id="newPasswordForm">
            <p style="text-align: left; margin-bottom: 1rem;">
                El código de seguridad fue ingresado con éxito. Por favor, define tu nueva contraseña.
            </p>
            
            <div style="text-align: left; margin-bottom: 15px; font-size: 0.9em; padding: 10px; border: 1px solid #e0f2fe; border-radius: 6px;">
                <p style="font-weight: 600; color: var(--secondary);">Tu contraseña debe cumplir con:</p>
                <ul style="list-style-type: none; padding-left: 0; margin-top: 5px;">
                    <li style="color: green;">✅ Tener entre 8 a 12 caracteres.</li>
                    <li style="color: green;">✅ Tener al menos un número.</li>
                    <li style="color: green;">✅ Tener al menos una letra mayúscula.</li>
                    <li style="color: #ef4444;">❌ No debe contener signos ni caracteres especiales.</li>
                    <li style="color: #ef4444;">❌ No debe contener espacios.</li>
                </ul>
            </div>
            
            <label for="newPassword">Nueva Contraseña:</label>
            <input type="password" id="newPassword" required><br><br>

            <label for="confirmPassword">Confirmar Contraseña:</label>
            <input type="password" id="confirmPassword" required><br><br>
            
            <div id="message" style="color: red; margin-bottom: 15px;"></div>

            <button type="submit" id="savePasswordButton">Guardar y Finalizar</button>
        </form>
    </div>

    <script>
        const API_URL_FINISH_RESET = 'https://raw-philipa-odvin123-8a860263.koyeb.app/api/finalizar-reset-pw';
        const messageDisplay = document.getElementById('message');
        const savePasswordButton = document.getElementById('savePasswordButton');
        let resetToken = ''; 

        function validatePassword(password) {
            if (password.length < 8 || password.length > 12) { return "La contraseña debe tener entre 8 y 12 caracteres."; }
            if (!/\d/.test(password)) { return "La contraseña debe contener al menos un número."; }
            if (!/[A-Z]/.test(password)) { return "La contraseña debe contener al menos una letra mayúscula."; }
            if (/[^a-zA-Z0-9]/.test(password)) { return "La contraseña no debe contener signos, caracteres especiales o espacios."; }
            return null; 
        }

        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            resetToken = urlParams.get('resetToken');
            
            if (!resetToken) {
                messageDisplay.style.color = 'red';
                messageDisplay.textContent = 'Error: Token de restablecimiento no encontrado o inválido. Por favor, vuelva a empezar el proceso.';
                savePasswordButton.disabled = true;
            }
        });

        newPasswordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            messageDisplay.textContent = '';
            savePasswordButton.disabled = true;
            savePasswordButton.textContent = 'Guardando...';

            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (newPassword !== confirmPassword) {
                messageDisplay.style.color = 'red';
                messageDisplay.textContent = 'Error: Las contraseñas no coinciden.';
                savePasswordButton.disabled = false;
                savePasswordButton.textContent = 'Guardar y Finalizar';
                return;
            }

            const validationError = validatePassword(newPassword);
            if (validationError) {
                messageDisplay.style.color = 'red';
                messageDisplay.textContent = `Error de contraseña: ${validationError}`;
                savePasswordButton.disabled = false;
                savePasswordButton.textContent = 'Guardar y Finalizar';
                return;
            }
            
            const data = { resetToken: resetToken, newPassword: newPassword };

            try {
                const response = await fetch(API_URL_FINISH_RESET, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    messageDisplay.style.color = 'green';
                    messageDisplay.textContent = '✅ Contraseña actualizada con éxito. Redirigiendo al login...';
                    
                    setTimeout(() => {
                        window.location.href = `login.html?tenant=${result.tenant_id}`; 
                    }, 2000);

                } else {
                    messageDisplay.style.color = 'red';
                    messageDisplay.textContent = result.message || 'Error al cambiar la contraseña. El token pudo haber expirado. Intente de nuevo.';
                }
            } catch (e) {
                messageDisplay.style.color = 'red';
                messageDisplay.textContent = 'Error de conexión con el servidor.';
            } finally {
                savePasswordButton.disabled = false;
                savePasswordButton.textContent = 'Guardar y Finalizar';
            }
        });
    </script>
</body>
</html>