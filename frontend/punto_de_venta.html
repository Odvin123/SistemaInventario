<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Punto de Venta - SAAS</title>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="css/punto_de_venta.css" />
    <style>
        .footer-data[style*="cursor: pointer"] {
            text-decoration: underline;
            font-weight: bold;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
        }
        .close {
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .pos-table {
            width: 100%;
            border-collapse: collapse;
        }
        .pos-table th,
        .pos-table td {
            padding: 8px 10px;
            text-align: left;
            border: 1px solid #dee2e6;
        }
        .pos-table th {
            background-color: #f8f9fa;
        }
        .btn-primary {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
        }
    </style>
</head>
<!-- Para generar PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<body>
    <main class="pos-window">
        <header class="pos-header">
            <div id="company-logo" class="pos-logo">
                √Årea para Logo
            </div>
           <div class="pos-title-area" style="text-align: left; flex: 1; padding-left: 20px;">
    <h1 id="company-name" class="pos-title" style="margin: 0; font-size: 1.6rem; color: #1e293b;">
        Bienvenido  <span id="empresa-nombre">Cargando...</span>
    </h1>
    <p id="tenant-display" class="pos-welcome" style="margin: 5px 0 0; font-size: 0.95rem; color: #64748b;">
        Puesto: <strong><span id="empresa-tenant">‚Äî</span></strong>
    </p>
</div>
<div class="folio-box">
    Folio: <span id="folio-number">Cargando...</span>
</div>
           <a href="inventario_dashboard.html" class="close-btn" aria-label="Regresar al Panel de Inventario" title="Regresar al Panel">
    &#x2715;
</a>

<style>
.close-btn {
    background: #ef4444;
    color: white;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
    font-size: 20px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.2s;
    margin-left: auto;
    margin-right: 15px;
}
.close-btn:hover {
    background: #dc2626;
    transform: scale(1.05);
}
</style>
        </header>

        <nav class="quick-menu" aria-label="Men√∫ R√°pido de POS">
            <button class="menu-btn" onclick="openWindow('vendedores.html')">Vendedores (<kbd>F2</kbd>)</button>
            <button class="menu-btn" onclick="openWindow('clientes.html')">Clientes (<kbd>F3</kbd>)</button>
            <button class="menu-btn" onclick="handleCorteCaja()">Corte caja (<kbd>F6</kbd>)</button>
            <button class="menu-btn" onclick="handleCancelarNV()">Cancelar NV (<kbd>F9</kbd>)</button>
        </nav>

        <section class="sale-input-area">
            <label for="barcode-input">VENTA DE PRODUCTOS / SERVICIOS</label>
            <div style="display: flex; align-items: center;">
                <input type="text" id="barcode-input" class="barcode-input" placeholder="Escanear C√≥digo o Buscar Producto">
                <button class="search-icon" aria-label="Buscar producto" onclick="openMovimientoVentasModal()">üîç</button> 
            </div>
            
            <div class="factura-checkbox">
                <input type="checkbox" id="check-factura">
                <label for="check-factura">Factura</label>
            </div>
        </section>

        <div class="pos-main">
            <div class="pos-table-container">
                <table class="pos-table" aria-label="Detalle de productos en la venta actual">
                    <thead>
                        <tr>
                            <th>CANT.</th>
                            <th>C√ìDIGO</th>
                            <th>PRODUCTO</th>
                            <th style="text-align: right;">PRECIO UNI.</th>
                            <th style="text-align: right;">IMPORTE</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="5" style="text-align: center; color: #aaa;">Presione üîç para a√±adir productos.</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="pos-actions-panel">
                <div class="action-btns">
                    <button class="action-btn btn-eliminar" onclick="removeItemFromSale()">Eliminar (<kbd>Supr</kbd>)</button>
                    <button class="action-btn btn-borrar" onclick="clearSale()">Borrar (<kbd>F7</kbd>)</button>
                </div>
                
                <div class="cobrar-area">
                    <button class="cobrar-btn" onclick="handleCobrar()">
                        Cobrar (<kbd>F8</kbd>)
                    </button>
                    <div id="total-amount" class="total-display" role="status" aria-live="polite">
                        C$0.00 
                    </div>
                </div>
            </div>
        </div>
        
        <footer class="pos-footer">
            <div class="footer-info">
                
                <span>Cliente: 
                    <span class="footer-data" id="footer-cliente" 
                          ondblclick="openClienteSelectionModal()" 
                          style="cursor: pointer; text-decoration: underline; font-weight: bold;">
                        PUBLICO EN GENERAL
                    </span>
                </span> 
                
                <span>Vendedor: 
                    <span class="footer-data" id="footer-vendedor" 
                          ondblclick="openVendedorSelectionModal()" 
                          style="cursor: pointer; text-decoration: underline; font-weight: bold;">
                        MOSTRADOR
                    </span>
                </span>
            </div>
            <div class="date-time-box">
                <time id="current-date">--</time>
                <time id="current-time">--</time>
            </div>
        </footer>
    </main>

    <!-- Modal de Producto -->
    <div id="movimientoVentasModal" class="modal" role="dialog" aria-labelledby="movimiento-title" aria-modal="true">
        <div class="modal-content" style="max-width: 700px;">
            <button class="close" aria-label="Cerrar" onclick="closeMovimientoVentasModal()">&times;</button>
            <h3 id="movimiento-title">Agregar Producto a Venta</h3>
            <form id="movimientoVentasForm">
                <label for="clasificacion">Clasificaci√≥n:</label>
                <select id="clasificacion" required onchange="filterProductsByClasificacion()">
                    <option value="TODOS">TODOS</option> 
                </select>
                
                <label for="producto_nombre">Producto:</label>
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <input type="text" id="producto_nombre" placeholder="Nombre o Descripci√≥n del Producto" disabled aria-readonly="true">
                    <button type="button" class="btn-edit" aria-label="Abrir buscador de productos" onclick="openBusquedaProductoModal()" style="padding: 10px;">üîç</button>
                </div>
                
                <div style="display: flex; gap: 20px;">
                    <div style="flex: 1;">
                        <label for="cantidad_venta">Cantidad a Vender:</label>
                        <input type="number" id="cantidad_venta" required min="1" step="1" value="1" oninput="validateStock()">
                    </div>
                    <div style="flex: 1;">
                        <label for="existencia_stock">Existencia (Stock):</label>
                        <input type="text" id="existencia_stock" disabled style="background-color: #f1f1f1;" value="--">
                    </div>
                    <div style="flex: 1;">
                        <label for="precio_unitario">Precio (C$):</label>
                        <input type="text" id="precio_unitario" disabled style="background-color: #f1f1f1;" value="C$0.00">
                    </div>
                </div>
                
                <input type="hidden" id="selected_product_id">
                <input type="hidden" id="selected_product_clave">
                <button type="submit" class="btn-add-product" style="width: 100%; margin-top: 15px;">A√±adir a la Venta</button>
            </form>
        </div>
    </div>

    <!-- Modal de B√∫squeda de Producto -->
    <div id="busquedaProductoModal" class="modal" role="dialog" aria-labelledby="busqueda-title" aria-modal="true">
        <div class="modal-content" style="max-width: 900px;">
            <button class="close" aria-label="Cerrar" onclick="closeBusquedaProductoModal()">&times;</button>
            <h3 id="busqueda-title">B√∫squeda de Producto</h3>
            <input type="text" id="filtro_descripcion" placeholder="Filtrar por nombre o descripci√≥n" oninput="filterBusquedaProductos()" style="width: 100%; margin-bottom: 15px;">
            
            <div id="busqueda-table-container" style="max-height: 400px; overflow-y: auto; margin-bottom: 15px;">
                <table id="busqueda-table" class="pos-table" style="width: 100%;" aria-label="Lista de productos en inventario">
                    <thead>
                        <tr>
                            <th>Clave</th>
                            <th>Descripci√≥n</th>
                            <th>Stock</th>
                            <th>Precio (C$)</th>
                            <th>Proveedor</th>
                            <th>Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody id="busqueda-tbody">
                        <tr><td colspan="6" style="text-align: center;">Cargando inventario...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal de Caja -->
    <div id="cajaModal" class="modal" role="dialog" aria-labelledby="caja-title" aria-modal="true">
        <div class="modal-content" style="max-width: 450px; text-align: center;">
            <button class="close" aria-label="Cerrar caja de cobro" onclick="closeCajaModal()">&times;</button>
            <h3 id="caja-title" style="color: #007bff; margin-bottom: 20px;">Caja de Cobro</h3>

            <h1 style="color: #333;">Total a Pagar:</h1>
            <h2 id="caja-total-a-pagar" style="color: #d9534f; font-size: 2.5rem; margin-top: 5px;" role="status" aria-live="polite">C$0.00</h2>
            <p id="total-letras" style="font-size: 0.8rem; color: #666;">--</p>
            
            <form id="cajaForm" style="margin-top: 20px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <label for="pago-efectivo">Efectivo (C$)</label>
                        <input type="number" id="pago-efectivo" value="0.00" step="0.01" min="0" oninput="calcularCambio()">
                    </div>
                    <div>
                        <label for="pago-tarjeta">Tarjeta (C$)</label>
                        <input type="number" id="pago-tarjeta" value="0.00" step="0.01" min="0" oninput="calcularCambio()">
                    </div>
                    <div>
                        <label for="pago-transferencia">Transferencia (C$)</label>
                        <input type="number" id="pago-transferencia" value="0.00" step="0.01" min="0" oninput="calcularCambio()">
                    </div>
                    <div>
                        <label for="pago-credito">Cr√©dito (C$)</label>
                        <input type="number" id="pago-credito" value="0.00" step="0.01" min="0" oninput="calcularCambio()">
                    </div>
                </div>
                
                <h3 style="margin-top: 25px;">Cambio:</h3>
                <h2 id="caja-monto-cambio" style="color: #28a745; font-size: 2rem;" role="status" aria-live="polite">C$0.00</h2>

                <div style="display: flex; justify-content: space-around; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn-edit" onclick="closeCajaModal()" style="background-color: #dc3545; color: white;">Cancelar</button>
                    <button type="button" class="btn-add-product" onclick="finalizarVentaDesdeCaja()" style="background-color: #28a745; color: white;">Aceptar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ‚úÖ Modal de Selecci√≥n de Cliente -->
    <div id="clienteSelectionModal" class="modal" role="dialog" aria-labelledby="cliente-modal-title" aria-modal="true">
        <div class="modal-content" style="max-width: 600px;">
            <button class="close" aria-label="Cerrar" onclick="closeClienteSelectionModal()">&times;</button>
            <h3 id="cliente-modal-title">Seleccionar Cliente</h3>
            <input type="text" id="filtro-cliente-pos" placeholder="Filtrar por nombre o ID" oninput="filterClientesPOS()" style="width: 100%; margin-bottom: 15px;">
            
            <div id="clientes-table-container" style="max-height: 400px; overflow-y: auto; margin-bottom: 15px;">
                <table id="clientes-table" class="pos-table" style="width: 100%;" aria-label="Lista de clientes">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody id="clientes-tbody">
                        <tr><td colspan="3" style="text-align: center;">Cargando clientes...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ‚úÖ Modal de Selecci√≥n de Vendedor -->
    <div id="vendedorSelectionModal" class="modal" role="dialog" aria-labelledby="vendedor-modal-title" aria-modal="true">
        <div class="modal-content" style="max-width: 600px;">
            <button class="close" aria-label="Cerrar" onclick="closeVendedorSelectionModal()">&times;</button>
            <h3 id="vendedor-modal-title">Seleccionar Vendedor</h3>
            <input type="text" id="filtro-vendedor-pos" placeholder="Filtrar por nombre o ID" oninput="filterVendedoresPOS()" style="width: 100%; margin-bottom: 15px;">
            
            <div id="vendedores-table-container" style="max-height: 400px; overflow-y: auto; margin-bottom: 15px;">
                <table id="vendedores-table" class="pos-table" style="width: 100%;" aria-label="Lista de vendedores">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody id="vendedores-tbody">
                        <tr><td colspan="3" style="text-align: center;">Cargando vendedores...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://raw-philipa-odvin123-8a860263.koyeb.app/api'; 
        let token = localStorage.getItem('token'); 
        let tenantId = localStorage.getItem('tenant_id');
        
        let ventaActual = []; 
        let productosInventarioCache = []; 
        let categoriasCache = [];
        let proveedoresCache = [];
        let clientesCachePOS = [];
        let vendedoresCachePOS = [];

        const defaultAdmin = 'ADMINISTRADOR'; 
        const defaultCliente = 'PUBLICO EN GENERAL';
        const defaultVendedor = 'MOSTRADOR';

        // ‚úÖ Funci√≥n para cargar estado inicial
        function loadState() {
            document.getElementById('footer-administrador').textContent = defaultAdmin; 

            const currentCliente = localStorage.getItem('currentClienteName') || defaultCliente;
            const currentVendedor = localStorage.getItem('currentVendedorName') || defaultVendedor;

            document.getElementById('footer-cliente').textContent = currentCliente;
            document.getElementById('footer-vendedor').textContent = currentVendedor;

            if (!localStorage.getItem('currentClienteId')) localStorage.setItem('currentClienteId', 1);
            if (!localStorage.getItem('currentVendedorId')) localStorage.setItem('currentVendedorId', 1);
        }

        // ‚úÖ Funciones para modales de cliente/vendedor
        function openClienteSelectionModal() {
            if (!token) { alert('Sesi√≥n no v√°lida. Por favor, inicie sesi√≥n.'); return; } 
            document.getElementById('clienteSelectionModal').style.display = 'block';
            if (clientesCachePOS.length === 0) {
                loadClientesForPOS();
            } else {
                renderClientesForPOS(clientesCachePOS);
            }
        }

        function closeClienteSelectionModal() {
            document.getElementById('clienteSelectionModal').style.display = 'none';
        }

        function openVendedorSelectionModal() {
            if (!token) { alert('Sesi√≥n no v√°lida. Por favor, inicie sesi√≥n.'); return; }
            document.getElementById('vendedorSelectionModal').style.display = 'block';
            if (vendedoresCachePOS.length === 0) {
                loadVendedoresForPOS();
            } else {
                renderVendedoresForPOS(vendedoresCachePOS);
            }
        }

        function closeVendedorSelectionModal() {
            document.getElementById('vendedorSelectionModal').style.display = 'none';
        }

        // ‚úÖ Carga y render de clientes/vendedores
        async function fetchData(endpoint) {
            try {
                const response = await fetch(`${API_URL}/admin/${endpoint}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) {
                    const error = await response.json();
                    console.error(`Error al cargar ${endpoint}:`, error);
                    return [];
                }
                const data = await response.json();
                return data[endpoint]; 
            } catch (error) { 
                console.error(`Error de conexi√≥n al cargar ${endpoint}:`, error); 
                return [];
            }
        }

        async function loadClientesForPOS() {
            const clientes = await fetchData('clientes'); 
            clientesCachePOS = clientes;
            renderClientesForPOS(clientes);
        }

        async function loadVendedoresForPOS() {
            const vendedores = await fetchData('vendedores'); 
            vendedoresCachePOS = vendedores;
            renderVendedoresForPOS(vendedores);
        }

        function renderClientesForPOS(clientes) {
            const tbody = document.getElementById('clientes-tbody');
            tbody.innerHTML = '';
            
            if (clientes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align: center;">No hay clientes registrados.</td></tr>';
                return;
            }

            clientes.forEach(c => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${c.id}</td>
                    <td>${c.nombre}</td>
                    <td style="text-align: center;">
                        <button class="btn-primary" 
                                onclick="selectClientFromModal('${c.nombre.replace(/'/g, "\\'")}', ${c.id})">Seleccionar</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderVendedoresForPOS(vendedores) {
            const tbody = document.getElementById('vendedores-tbody');
            tbody.innerHTML = '';
            
            if (vendedores.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align: center;">No hay vendedores registrados.</td></tr>';
                return;
            }

            vendedores.forEach(v => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${v.id}</td>
                    <td>${v.nombre}</td>
                    <td style="text-align: center;">
                        <button class="btn-primary" 
                                onclick="selectVendedorFromModal('${v.nombre.replace(/'/g, "\\'")}', ${v.id})">Seleccionar</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function filterClientesPOS() {
            const filtro = document.getElementById('filtro-cliente-pos').value.toLowerCase();
            const clientesFiltrados = clientesCachePOS.filter(c => 
                c.nombre.toLowerCase().includes(filtro) || 
                c.id.toString().includes(filtro) 
            );
            renderClientesForPOS(clientesFiltrados);
        }

        function filterVendedoresPOS() {
            const filtro = document.getElementById('filtro-vendedor-pos').value.toLowerCase();
            const vendedoresFiltrados = vendedoresCachePOS.filter(v => 
                v.nombre.toLowerCase().includes(filtro) || 
                v.id.toString().includes(filtro) 
            );
            renderVendedoresForPOS(vendedoresFiltrados);
        }

        // ‚úÖ Seleccionar y actualizar
        function selectClientFromModal(name, id) {
            updateSelectedEntity('cliente', name, id); 
            closeClienteSelectionModal();
        }

        function selectVendedorFromModal(name, id) {
            updateSelectedEntity('vendedor', name, id); 
            closeVendedorSelectionModal();
        }

        window.updateSelectedEntity = function(type, name, id) {
            if (type === 'cliente') {
                localStorage.setItem('currentClienteName', name);
                localStorage.setItem('currentClienteId', id); 
                document.getElementById('footer-cliente').textContent = name;
            } else if (type === 'vendedor') {
                localStorage.setItem('currentVendedorName', name);
                localStorage.setItem('currentVendedorId', id); 
                document.getElementById('footer-vendedor').textContent = name;
            }
        }

        // ‚úÖ Funciones existentes (sin cambios, solo ajuste para ticket)

        function openMovimientoVentasModal() {
            if (!token) {
                alert('Sesi√≥n no v√°lida. Por favor, inicie sesi√≥n.');
                window.location.href = 'login.html'; 
                return;
            }
            document.getElementById('movimientoVentasModal').style.display = 'block';
            loadCategoriasAndInitBusqueda();
        }

        function closeMovimientoVentasModal() {
            document.getElementById('movimientoVentasModal').style.display = 'none';
            document.getElementById('movimientoVentasForm').reset();
            clearMovimientoInputs(); 
        }

        function openBusquedaProductoModal() {
            document.getElementById('busquedaProductoModal').style.display = 'block';
            filterProductsByClasificacion(true); 
            document.getElementById('filtro_descripcion').value = '';
            document.getElementById('filtro_descripcion').focus();
        }

        function closeBusquedaProductoModal() {
            document.getElementById('busquedaProductoModal').style.display = 'none';
        }

        function openCajaModal(total, clienteNombre, vendedorNombre) {
            document.getElementById('cajaModal').style.display = 'block';
            document.getElementById('pago-efectivo').value = total.toFixed(2);
            document.getElementById('caja-total-a-pagar').textContent = `C$${total.toFixed(2)}`;
            document.getElementById('total-letras').textContent = '(Monto en letras no implementado)';
            calcularCambio();

            // Guardar para el ticket
            window.currentClienteNombre = clienteNombre;
            window.currentVendedorNombre = vendedorNombre;
        }

        function closeCajaModal() {
            document.getElementById('cajaModal').style.display = 'none';
            document.getElementById('cajaForm').reset();
        }

        function calcularCambio() {
            const totalVentaStr = document.getElementById('total-amount').textContent.replace('C$', '');
            const totalVenta = parseFloat(totalVentaStr);
            
            const efectivo = parseFloat(document.getElementById('pago-efectivo').value) || 0;
            const tarjeta = parseFloat(document.getElementById('pago-tarjeta').value) || 0;
            const transferencia = parseFloat(document.getElementById('pago-transferencia').value) || 0;
            const credito = parseFloat(document.getElementById('pago-credito').value) || 0;

            const totalPagado = efectivo + tarjeta + transferencia + credito;
            const cambio = totalPagado - totalVenta;
            
            const cambioDisplay = document.getElementById('caja-monto-cambio');
            cambioDisplay.textContent = `C$${cambio.toFixed(2)}`;
            cambioDisplay.style.color = cambio >= 0 ? '#28a745' : '#dc3545';
        }

        async function loadCategoriasAndInitBusqueda() {
            await Promise.all([loadCategoriasPDV(), loadInventarioPDV(), loadProveedoresPDV()]);
            renderClasificaciones();
        }

        async function loadCategoriasPDV() {
            categoriasCache = await fetchData('categorias');
        }

        async function loadInventarioPDV() {
            productosInventarioCache = await fetchData('productos');
            if (document.getElementById('busquedaProductoModal').style.display === 'block') {
                renderBusquedaProductos(productosInventarioCache);
            }
        }

        async function loadProveedoresPDV() {
            proveedoresCache = await fetchData('proveedores');
        }

        function renderClasificaciones() {
            const select = document.getElementById('clasificacion');
            select.innerHTML = '<option value="TODOS">TODOS</option>';
            categoriasCache.forEach(c => {
                select.innerHTML += `<option value="${c.id}">${c.nombre}</option>`;
            });
        }

        function filterProductsByClasificacion(isInitialLoad = false) {
            const clasificacionId = document.getElementById('clasificacion').value;
            if (!isInitialLoad) clearMovimientoInputs(); 
            
            let productosFiltrados = productosInventarioCache;
            if (clasificacionId !== 'TODOS') {
                productosFiltrados = productosInventarioCache.filter(p => p.categoria_id == clasificacionId);
            }
            
            if (document.getElementById('busquedaProductoModal').style.display === 'block') {
                renderBusquedaProductos(productosFiltrados);
            }
        }

        function filterBusquedaProductos() {
            const filtro = document.getElementById('filtro_descripcion').value.toLowerCase();
            const clasificacionId = document.getElementById('clasificacion').value;
            
            let productosBase = productosInventarioCache;
            
            if (clasificacionId !== 'TODOS') {
                productosBase = productosBase.filter(p => p.categoria_id == clasificacionId);
            }
            
            const productosFiltrados = productosBase.filter(p => 
                p.descripcion.toLowerCase().includes(filtro) || 
                p.id.toString().includes(filtro) 
            );
            
            renderBusquedaProductos(productosFiltrados);
        }

        function renderBusquedaProductos(productos) {
            const tbody = document.getElementById('busqueda-tbody');
            tbody.innerHTML = '';
            
            if (productos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No se encontraron productos.</td></tr>';
                return;
            }

            productos.forEach(p => {
                const proveedor = proveedoresCache.find(prov => prov.id === p.proveedor_id);
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${p.id}</td>
                    <td>${p.descripcion}</td>
                    <td>${p.stock}</td>
                    <td style="text-align: right;">C$${parseFloat(p.precio).toFixed(2)}</td>
                    <td>${proveedor ? proveedor.nombre : 'N/A'}</td>
                    <td style="text-align: center;">
                        <button type="button" class="btn-add-product" 
                                onclick="selectProductForSale(${p.id})">Seleccionar</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function selectProductForSale(productId) {
            const producto = productosInventarioCache.find(p => p.id === productId);
            if (!producto) return;
            
            document.getElementById('selected_product_id').value = producto.id;
            document.getElementById('selected_product_clave').value = producto.id; 
            document.getElementById('producto_nombre').value = producto.descripcion;
            document.getElementById('existencia_stock').value = producto.stock;
            document.getElementById('precio_unitario').value = `C$${parseFloat(producto.precio).toFixed(2)}`;
            document.getElementById('cantidad_venta').value = 1;
            
            closeBusquedaProductoModal();
            validateStock(); 
        }

        function validateStock() {
            const stock = parseInt(document.getElementById('existencia_stock').value);
            const cantidadInput = document.getElementById('cantidad_venta');
            let cantidad = parseInt(cantidadInput.value);

            if (isNaN(cantidad) || cantidad <= 0) {
                cantidadInput.value = 1;
                cantidad = 1;
            }

            if (stock !== '--' && stock < cantidad) {
                alert(`Stock Insuficiente. Solo hay ${stock} unidades disponibles.`);
                cantidadInput.value = stock > 0 ? stock : 1; 
                if (stock <= 0) {
                    alert("Este producto no tiene stock disponible.");
                    cantidadInput.value = 1;
                }
            }
        }

        document.getElementById('movimientoVentasForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const productId = parseInt(document.getElementById('selected_product_id').value);
            const cantidad = parseInt(document.getElementById('cantidad_venta').value);
            const stock = parseInt(document.getElementById('existencia_stock').value);
            const precioStr = document.getElementById('precio_unitario').value.replace('C$', '');
            const precio = parseFloat(precioStr);
            
            if (!productId) {
                alert("Debe seleccionar un producto primero.");
                return;
            }
            
            if (cantidad <= 0 || isNaN(cantidad)) {
                alert("La cantidad debe ser un n√∫mero positivo.");
                return;
            }
            
            const productoData = productosInventarioCache.find(p => p.id === productId);
            if (!productoData) return;

            const existingItem = ventaActual.find(item => item.id === productId);
            const currentlyInSale = existingItem ? existingItem.cantidad : 0;
            
            if ((currentlyInSale + cantidad) > stock) {
                alert(`Stock Insuficiente. Al a√±adir ${cantidad}, se superar√≠a el stock disponible de ${stock}.`);
                return;
            }

            addProductToSale(productoData, cantidad, precio);
            closeMovimientoVentasModal();
        });

        function addProductToSale(producto, cantidad, precio) {
            const importe = cantidad * precio;
            
            const existingItem = ventaActual.find(item => item.id === producto.id);
            
            if (existingItem) {
                existingItem.cantidad += cantidad;
                existingItem.importe = existingItem.cantidad * existingItem.precio;
            } else {
                ventaActual.push({
                    id: producto.id,
                    clave: producto.id,
                    descripcion: producto.descripcion,
                    cantidad: cantidad,
                    precio: precio,
                    importe: importe
                });
            }
            
            renderVentaActual();
        }

        function removeItemFromSale() {
            if (ventaActual.length > 0) {
                ventaActual.pop();
                renderVentaActual();
            } else {
                alert("No hay elementos para eliminar.");
            }
        }

        function clearSale() {
            if (confirm("¬øEst√° seguro de borrar toda la venta actual?")) {
                ventaActual = [];
                renderVentaActual();
            }
        }

        function renderVentaActual() {
            const tbody = document.querySelector('.pos-table tbody');
            tbody.innerHTML = '';
            let totalVenta = 0;

            if (ventaActual.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #aaa;">Presione üîç para a√±adir productos.</td></tr>';
                document.getElementById('total-amount').textContent = 'C$0.00';
                return;
            }

            ventaActual.forEach(item => {
                totalVenta += item.importe;
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.cantidad}</td>
                    <td>${item.clave}</td>
                    <td>${item.descripcion}</td>
                    <td style="text-align: right;">C$${item.precio.toFixed(2)}</td>
                    <td style="text-align: right;">C$${item.importe.toFixed(2)}</td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('total-amount').textContent = `C$${totalVenta.toFixed(2)}`;
        }
        
        function clearMovimientoInputs() {
            document.getElementById('selected_product_id').value = '';
            document.getElementById('selected_product_clave').value = '';
            document.getElementById('producto_nombre').value = '';
            document.getElementById('existencia_stock').value = '--';
            document.getElementById('precio_unitario').value = 'C$0.00';
            document.getElementById('cantidad_venta').value = '1';
        }

        function updateDateTime() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('es-NI', {
                day: '2-digit', month: '2-digit', year: 'numeric'
            });
            const timeStr = now.toLocaleTimeString('es-NI', {
                hour: '2-digit', minute: '2-digit', second: '2-digit'
            });

            document.getElementById('current-date').textContent = dateStr;
            document.getElementById('current-time').textContent = timeStr;
        }

        function openWindow(url) {
            const width = 1000;
            const height = 700;
            const left = (screen.width / 2) - (width / 2);
            const top = (screen.height / 2) - (height / 2);
            
            const newWindow = window.open(
                url,
                'CatalogosPOSWindow', 
                `width=${width},height=${height},top=${top},left=${left},scrollbars=yes,resizable=yes`
            );

            if (newWindow) {
                newWindow.focus();
            } else {
                alert('El navegador bloque√≥ la ventana emergente. Por favor, perm√≠talas.');
            }
        }

        // ‚úÖ Manejo de cobro y ticket
        function handleCobrar() {
            if (ventaActual.length === 0) {
                alert("No hay productos en la venta para cobrar.");
                return;
            }

            const clienteActualNombre = localStorage.getItem('currentClienteName') || 'PUBLICO EN GENERAL';
            const vendedorActualNombre = localStorage.getItem('currentVendedorName') || 'MOSTRADOR';

            const totalVentaStr = document.getElementById('total-amount').textContent.replace('C$', '');
            const totalVenta = parseFloat(totalVentaStr);

            openCajaModal(totalVenta, clienteActualNombre, vendedorActualNombre);
        }

        async function finalizarVentaDesdeCaja() {
            const totalVentaStr = document.getElementById('total-amount').textContent.replace('C$', '');
            const totalVenta = parseFloat(totalVentaStr);

            const efectivo = parseFloat(document.getElementById('pago-efectivo').value) || 0;
            const tarjeta = parseFloat(document.getElementById('pago-tarjeta').value) || 0;
            const transferencia = parseFloat(document.getElementById('pago-transferencia').value) || 0;
            const credito = parseFloat(document.getElementById('pago-credito').value) || 0;
            
            const totalPagado = efectivo + tarjeta + transferencia + credito;

            if (totalPagado < totalVenta) {
                alert(`¬°ERROR! Falta pagar C$${(totalVenta - totalPagado).toFixed(2)}. Complete el pago.`);
                return;
            }
            
            const pagos = [];
            if (efectivo > 0) pagos.push({ metodo: 'Efectivo', monto: efectivo });
            if (tarjeta > 0) pagos.push({ metodo: 'Tarjeta', monto: tarjeta });
            if (transferencia > 0) pagos.push({ metodo: 'Transferencia', monto: transferencia });
            if (credito > 0) pagos.push({ metodo: 'Credito', monto: credito });

            if (pagos.length === 0) {
                alert("Debe ingresar al menos un pago para finalizar la venta.");
                return;
            }
            
            const btnAceptar = document.querySelector('#cajaModal .btn-add-product');
            btnAceptar.disabled = true;

            try {
                const ventaData = {
                    cliente_id: parseInt(localStorage.getItem('currentClienteId')) || 1, 
                    vendedor_id: parseInt(localStorage.getItem('currentVendedorId')) || 1, 
                    es_factura: document.getElementById('check-factura').checked,
                    detalles: ventaActual.map(item => ({
                        producto_id: item.id,
                        cantidad: item.cantidad,
                        precio_unitario: item.precio
                    })),
                    pagos: pagos 
                };

                const response = await fetch(`${API_URL}/admin/ventas`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(ventaData)
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    alert(`¬°√âXITO! Venta #${result.folio} registrada. Cambio a devolver: C$${result.cambio}`);

                    // ‚úÖ GENERAR TICKET AUTOM√ÅTICAMENTE
                    const clienteActualNombre = window.currentClienteNombre || 'PUBLICO EN GENERAL';
                    const vendedorActualNombre = window.currentVendedorNombre || 'MOSTRADOR';

                    generateTicket(
                        result.folio,
                        ventaActual,
                        totalVenta,
                        clienteActualNombre,
                        vendedorActualNombre,
                        result.cambio
                    );

                    ventaActual = [];
                    renderVentaActual();
                    closeCajaModal();
                    loadInventarioPDV(); 
                    
                } else {
                    alert('Error al registrar la venta: ' + (result.message || 'Error desconocido del servidor.'));
                }
            } catch (error) {
                alert('Error de conexi√≥n o de red al procesar la venta.');
                console.error('Error en fetch (finalizarVentaDesdeCaja):', error);
            } finally {
                btnAceptar.disabled = false; 
            }
        }

       function generateTicket(folio, productos, total, clienteNombre, vendedorNombre, cambio) {
    const now = new Date();
    const fechaHora = now.toLocaleString('es-NI');

    // ‚úÖ Incluir nombre de la empresa
    const nombreEmpresa = localStorage.getItem('nombre_empresa') || 'TU EMPRESA';

    const ticketData = {
        folio,
        fechaHora,
        clienteNombre,
        vendedorNombre,
        productos,
        total,
        cambio,
        nombreEmpresa  // ‚úÖ Clave: sin esto, el ticket no muestra la empresa
    };

    sessionStorage.setItem('ticketData', JSON.stringify(ticketData));
    const ticketWindow = window.open('ticket.html', '_blank', 'width=350,height=600,resizable,scrollbars');
    
    if (!ticketWindow) {
        alert('‚ö†Ô∏è El navegador bloque√≥ la ventana emergente. Permita ventanas emergentes.');
    }
}
        // Atajos de teclado
        document.addEventListener('keydown', function(event) {
            const tagName = event.target.tagName.toLowerCase();
            const isInput = (tagName === 'input' || tagName === 'textarea');
            
            if (event.code === 'F2' && !isInput) {
                event.preventDefault(); 
                openWindow('vendedores.html');
            } else if (event.code === 'F3' && !isInput) {
                event.preventDefault(); 
                openWindow('clientes.html');
            } else if (event.code === 'F6' && !isInput) {
                event.preventDefault(); 
                handleCorteCaja(); 
            } else if (event.code === 'F7' && !isInput && ventaActual.length > 0) {
                event.preventDefault();
                clearSale();
            } else if (event.code === 'F8' && !isInput) {
                event.preventDefault();
                handleCobrar();
            } else if (event.code === 'F9' && !isInput) {
                event.preventDefault();
                handleCancelarNV(); 
            } else if (event.key === 'Delete' && !isInput) {
                event.preventDefault();
                removeItemFromSale();
            } else if (event.code === 'Enter' && event.target.id === 'barcode-input') {
                event.preventDefault(); 
                openMovimientoVentasModal(); 
            }
        });

       // ‚úÖ Inicializaci√≥n
       document.addEventListener('DOMContentLoaded', async () => {
    if (!token) {
        alert('Sesi√≥n no v√°lida. Redirigiendo al login.');
        window.location.href = 'login.html';
        return;
    }

    loadState();

    // ‚úÖ 1. Mostrar nombre de empresa y tenant_id
    const nombreEmpresa = localStorage.getItem('nombre_empresa') || 'TU EMPRESA';
    document.getElementById('company-name').textContent = `BIENVENIDO ${nombreEmpresa}`;
    document.getElementById('tenant-display').textContent = tenantId || '‚Äî';

   // ‚úÖ 2. Cargar folio din√°mico desde backend
try {
    const folioRes = await fetch(`${API_URL}/admin/ventas/folio_actual`, {
        headers: { 'Authorization': `Bearer ${token}` }
    });
    const folioData = await folioRes.json();
    document.getElementById('folio-number').textContent = folioData.success ? folioData.folio : '1';
} catch (e) {
    console.error('Error al cargar folio:', e);
    document.getElementById('folio-number').textContent = '1';
}

    updateDateTime();
    setInterval(updateDateTime, 1000);
    renderVentaActual();
    
    document.querySelector('.search-icon').addEventListener('click', openMovimientoVentasModal);
    document.getElementById('barcode-input').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault(); 
            openMovimientoVentasModal(); 
        }
    });
    
    const cobrarBtn = document.querySelector('.cobrar-btn');
    if(cobrarBtn) {
        cobrarBtn.removeEventListener('click', handleCobrar); 
        cobrarBtn.addEventListener('click', handleCobrar);
    }
    
    await loadCategoriasAndInitBusqueda();
});

        // Funciones placeholder (para evitar errores si se llaman)
        function handleCorteCaja() { alert('Funci√≥n de corte de caja no implementada.'); }
        function handleCancelarNV() { 
            if (confirm("¬øCancelar venta actual?")) {
                ventaActual = [];
                renderVentaActual();
            }
        }
        function saveProveedor() {}
        function saveCategoria() {}
        function saveProduct() {}

    </script>
</body>
</html>