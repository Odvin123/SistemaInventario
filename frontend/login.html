<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Iniciar Sesi√≥n - InvenSaaS</title>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="css/StyleLogin.css" /> 
</head>
<body>
    <div id="login-container">
        <h2>Acceso al Sistema</h2>
        <form id="loginForm">
            <label for="tenantId">ID de Puesto/Empresa (Tenant ID):</label>
            <input type="text" id="tenantId" required><br><br>

            <label for="email">Correo Electr√≥nico:</label>
            <input type="email" id="email" required><br><br>

           <label for="password">Contrase√±a:</label>
            <div style="position: relative; display: inline-block; width: 100%;">
            <input type="password" id="password" required style="width: calc(100% - 40px); padding-right: 40px;">
         <button type="button" 
          id="togglePassword" 
          style="position: absolute; right: 2px; top: 2px; height: calc(100% - 4px); width: 36px; background: transparent; border: none; cursor: pointer; font-size: 18px;"
          aria-label="Mostrar u ocultar contrase√±a">üëÅÔ∏è
            
            </button>
            </div><br><br>
            <a href="index.html" class="btn-back-home" style="
    display: inline-block;
    margin-bottom: 15px;
    padding: 8px 16px;
    background-color: #6c757d;
    color: white;
    text-decoration: none;
    border-radius: 4px;
    font-size: 0.9em;
    font-weight: 500;
">‚Üê Volver al Inicio</a><br><br>

            <button type="submit" id="loginButton">Iniciar Sesi√≥n</button>
            <p id="lockoutMessage" style="color: red; display: none; margin-top: 10px;">Demasiados intentos fallidos. Intente de nuevo en <span id="countdown">10</span> segundos.</p>
        </form>
        
        <div style="margin-top: 15px;">
            <a href="#" id="forgotPasswordLink" style="color: var(--primary); text-decoration: none; font-size: 0.9em; font-weight: 500;">¬øSe te olvid√≥ la contrase√±a?</a>
        </div>
    </div>

    <script>


        const API_URL_LOGIN = 'http://localhost:4000/api/login';
        const loginForm = document.getElementById('loginForm');
        const loginButton = document.getElementById('loginButton');
        const lockoutMessage = document.getElementById('lockoutMessage');
        const countdownSpan = document.getElementById('countdown');
        
        let failCount = 0;
        const MAX_ATTEMPTS = 3;
        const LOCKOUT_DURATION_MS = 10000; 
        let isLocked = false;


        // Toggle de visibilidad de contrase√±a
document.getElementById('togglePassword').addEventListener('click', function() {
    const passwordInput = document.getElementById('password');
    const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
    passwordInput.setAttribute('type', type);
    this.textContent = type === 'password' ? 'üëÅÔ∏è' : 'üôà';
});


        function setLockout(duration) {
            isLocked = true;
            failCount = 0; 
            
            document.getElementById('tenantId').disabled = true;
            document.getElementById('email').disabled = true;
            document.getElementById('password').disabled = true;
            loginButton.disabled = true;
            document.getElementById('forgotPasswordLink').style.pointerEvents = 'none';

            lockoutMessage.style.display = 'block';

            let countdown = duration / 1000;
            countdownSpan.textContent = countdown;
            
            const timer = setInterval(() => {
                countdown--;
                countdownSpan.textContent = countdown;

                if (countdown <= 0) {
                    clearInterval(timer);
                    unlockForm();
                }
            }, 1000);
        }

        function unlockForm() {
            isLocked = false;
            
            document.getElementById('tenantId').disabled = false;
            document.getElementById('email').disabled = false;
            document.getElementById('password').disabled = false;
            loginButton.disabled = false;
            document.getElementById('forgotPasswordLink').style.pointerEvents = 'auto';

            lockoutMessage.style.display = 'none';
            alert('El bloqueo temporal ha finalizado. Puede intentar iniciar sesi√≥n de nuevo.');
        }


        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (isLocked) {
                alert('El formulario est√° bloqueado temporalmente. Por favor, espere.');
                return;
            }

            const tenant_id = document.getElementById('tenantId').value;
            const correo_electronico = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            const data = { tenant_id, correo_electronico, password };

            try {
                const response = await fetch(API_URL_LOGIN, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    failCount = 0; 
                    
                    localStorage.setItem('token', result.token); 
                    localStorage.setItem('rol', result.rol);
                    localStorage.setItem('tenant_id', result.tenant_id);
                    localStorage.setItem('nombre_empresa', result.nombre_empresa);

                 sessionStorage.setItem('authToken', result.token); 
                    sessionStorage.setItem('userRol', result.rol);
                    sessionStorage.setItem('tenantId', result.tenant_id);
                    sessionStorage.setItem('nombre_empresa', result.nombre_empresa);
                    
                    if (result.necesitaCambioPw) {
                        alert("Por seguridad, debe establecer una nueva contrase√±a.");
                        window.location.href = `cambio_pw.html?tenant=${result.tenant_id}&email=${correo_electronico}`;
                    } else {
                        if (result.rol === 'super_admin') {
                            window.location.href = 'superadmin_dashboard.html';
                        } else {
                            window.location.href = 'inventario_dashboard.html';
                        }
                    }

                } else {
                    failCount++;
                    
                    alert('Error de Login: ' + (result.message || 'Credenciales o Puesto/Empresa inv√°lido.'));

                    if (failCount >= MAX_ATTEMPTS) {
                        setLockout(LOCKOUT_DURATION_MS);
                    } else {
                        const remaining = MAX_ATTEMPTS - failCount;
                        if (remaining > 0) {
                            alert(`Intento fallido. Le quedan ${remaining} intentos antes del bloqueo temporal.`);
                        }
                    }
                }
            } catch (e) {
                alert('Error de conexi√≥n con el servidor (API no responde).');
            }
        });
        
        document.getElementById('forgotPasswordLink').addEventListener('click', (e) => {
            e.preventDefault();
            
            const tenantId = document.getElementById('tenantId').value;
            const email = document.getElementById('email').value;

            window.location.href = `reset_password.html?tenant=${encodeURIComponent(tenantId)}&email=${encodeURIComponent(email)}`;
        });
        
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const tenant = urlParams.get('tenant');
            if (tenant) {
                document.getElementById('tenantId').value = tenant;
            }
        });
    </script>
</body>
</html>