<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ticket de Venta</title>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Lato', sans-serif;
            background: white;
            color: #333;
            max-width: 320px;
            margin: 20px auto;
            padding: 15px;
            border: 1px solid #ccc;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        .header { text-align: center; margin-bottom: 12px; }
        .header h1 {
            font-size: 1.3rem;
            font-weight: 700;
            margin: 0;
            color: #1e293b;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            margin: 4px 0;
        }
        .label { font-weight: 600; color: #333; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 0.85rem;
        }
        th {
            background: #2563eb;
            color: white;
            padding: 6px 8px;
            text-align: left;
            font-weight: 700;
        }
        td {
            padding: 6px 8px;
            border-bottom: 1px solid #eee;
        }
        .total-row {
            display: flex;
            justify-content: space-between;
            font-weight: bold;
            margin: 10px 0;
            padding-top: 8px;
            border-top: 1px solid #ddd;
        }
        .cambio { color: #10b981; }
        .footer {
            text-align: center;
            font-size: 0.8rem;
            color: #666;
            margin-top: 20px;
            padding-top: 10px;
            border-top: 1px dashed #ccc;
        }
        .download-btn {
            display: block;
            width: 100%;
            padding: 8px;
            margin-top: 15px;
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }
        .download-btn:hover {
            background: linear-gradient(135deg, #1d4ed8, #1e40af);
            transform: translateY(-1px);
        }
    </style>
</head>
<body>
    <div class="header">
        <h1 id="ticket-company">CARGANDO...</h1>
    </div>

    <div class="info-row">
        <span class="label">Folio:</span>
        <span id="ticket-folio">#--</span>
    </div>
    <div class="info-row">
        <span class="label">Fecha/Hora:</span>
        <span id="ticket-fecha">--</span>
    </div>
    <div class="info-row">
        <span class="label">Cliente:</span>
        <span id="ticket-cliente">--</span>
    </div>
    <div class="info-row">
        <span class="label">Vendedor:</span>
        <span id="ticket-vendedor">--</span>
    </div>

    <table>
        <thead>
            <tr>
                <th>CANT.</th>
                <th>C√ìDIGO</th>
                <th>DESCRIPCI√ìN</th>
                <th style="text-align: right;">PRECIO</th>
                <th style="text-align: right;">TOTAL</th>
            </tr>
        </thead>
        <tbody id="ticket-items">
            <tr><td colspan="5" style="text-align: center;">Cargando...</td></tr>
        </tbody>
    </table>

    <div class="total-row">
        <span>Total:</span>
        <span id="ticket-total">C$0.00</span>
    </div>
    <div class="total-row cambio">
        <span>Cambio:</span>
        <span id="ticket-cambio">C$0.00</span>
    </div>

    <div class="footer">
        ¬°Gracias por su compra!
    </div>

    <button class="download-btn" onclick="downloadTicket()">üì• Descargar Ticket</button>

    <script>
        // ‚úÖ Recuperar datos desde sessionStorage
        const ticketData = JSON.parse(sessionStorage.getItem('ticketData'));
        if (!ticketData) {
            document.body.innerHTML = `
                <div style="text-align:center; padding:30px; color:#dc3545;">
                    <h2>‚ùå Ticket no disponible</h2>
                    <p>La venta no se registr√≥ correctamente.</p>
                </div>
            `;
            throw new Error('No ticket data');
        }

        // ‚úÖ Rellenar encabezado
        document.getElementById('ticket-company').textContent = ticketData.nombreEmpresa;
        document.getElementById('ticket-folio').textContent = `#${ticketData.folio}`;
        document.getElementById('ticket-fecha').textContent = ticketData.fechaHora;
        document.getElementById('ticket-cliente').textContent = ticketData.clienteNombre;
        document.getElementById('ticket-vendedor').textContent = ticketData.vendedorNombre;

        // ‚úÖ Rellenar productos
        const tbody = document.getElementById('ticket-items');
        tbody.innerHTML = ''; // Limpiar

        if (ticketData.productos && ticketData.productos.length > 0) {
            ticketData.productos.forEach(p => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${p.cantidad || 1}</td>
                    <td>${p.id || p.clave || '‚Äî'}</td>
                    <td>${p.descripcion || 'Sin descripci√≥n'}</td>
                    <td style="text-align: right;">C$${(p.precio || 0).toFixed(2)}</td>
                    <td style="text-align: right;">C$${(p.importe || p.cantidad * p.precio || 0).toFixed(2)}</td>
                `;
                tbody.appendChild(row);
            });
        } else {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #666;">Sin productos</td></tr>';
        }

        // ‚úÖ Rellenar totales
        document.getElementById('ticket-total').textContent = `C$${(ticketData.total || 0).toFixed(2)}`;
        document.getElementById('ticket-cambio').textContent = `C$${(ticketData.cambio || 0).toFixed(2)}`;

        // ‚úÖ Funci√≥n de descarga
        function downloadTicket() {
            const content = `
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Ticket #${ticketData.folio}</title>
                    <style>
                        body { font-family: 'Lato', sans-serif; max-width: 320px; margin: 0 auto; padding: 15px; }
                        table { width: 100%; border-collapse: collapse; }
                        th, td { padding: 5px; border: 1px solid #ccc; }
                        th { background: #2563eb; color: white; }
                        .footer { margin-top: 20px; text-align: center; font-size: 0.8rem; }
                    </style>
                </head>
                <body>
                    <div style="text-align:center;"><h2>${ticketData.nombreEmpresa}</h2></div>
                    <div>Folio: #${ticketData.folio}</div>
                    <div>Fecha: ${ticketData.fechaHora}</div>
                    <div>Cliente: ${ticketData.clienteNombre}</div>
                    <div>Vendedor: ${ticketData.vendedorNombre}</div>
                    <table>
                        <tr><th>CANT.</th><th>C√ìDIGO</th><th>DESCRIPCI√ìN</th><th>PRECIO</th><th>TOTAL</th></tr>
                        ${ticketData.productos?.map(p => 
                            `<tr>
                                <td>${p.cantidad}</td>
                                <td>${p.id}</td>
                                <td>${p.descripcion}</td>
                                <td>C$${p.precio.toFixed(2)}</td>
                                <td>C$${p.importe.toFixed(2)}</td>
                            </tr>`
                        ).join('') || '<tr><td colspan="5">Sin productos</td></tr>'}
                    </table>
                    <div style="margin-top:10px;">Total: C$${ticketData.total.toFixed(2)}</div>
                    <div>Cambio: C$${ticketData.cambio.toFixed(2)}</div>
                    <div class="footer">¬°Gracias por su compra!</div>
                </body>
                </html>
            `;
            
            const blob = new Blob([content], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ticket_${ticketData.folio}.html`;
            document.body.appendChild(a);
            a.click();
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 100);
        }
    </script>
</body>
</html>