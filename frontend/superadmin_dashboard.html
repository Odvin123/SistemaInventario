<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | SuperAdmin</title>
    <style>
        .dashboard-container { padding: 20px; background-color: #e6f7ff; min-height: 100vh; }
        .dashboard-container h1 { color: #004d99; }
        .dashboard-menu { margin-bottom: 20px; }
        .dashboard-menu button, .dashboard-menu a {
            padding: 8px 15px; margin: 0 5px; background-color: #007bff;
            color: white; border: none; border-radius: 5px;
            cursor: pointer; text-decoration: none;
        }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background-color: white; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .btn-delete { background-color: #dc3545; } 
    </style>
</head>
<body>
    <div class="dashboard-container">
        <h1>ğŸš€ Panel de Control SuperAdmin</h1>
        <p>GestiÃ³n Centralizada de Inquilinos (Puestos/Empresas)</p>
        
        <div class="dashboard-menu">
            <button onclick="showCreateForm()">â• Crear Nuevo Puesto/Empresa</button>
            <a href="login.html" onclick="sessionStorage.clear()">Cerrar SesiÃ³n</a>
        </div>
        
        <hr>
        <h2>Lista de Empresas Registradas</h2>
        <div id="loading-message" style="color: blue;">Cargando empresas...</div>
        <table id="empresas-table" style="display:none;">
            <thead>
Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>ID Interno</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Tenant ID</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Nombre Empresa</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Correo Admin</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Estado</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Registro</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Acciones</th> 
Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  </thead>
            <tbody id="empresas-tbody">
            </tbody>
        </table>
    </div>

    <script>
        const API_URL_EMPRESAS = 'http://localhost:4000/api/admin/empresas';
        const API_URL_REGISTER = 'http://localhost:4000/api/register';
        const API_URL_ADMIN_RESET = 'http://localhost:4000/api/admin/reset-pw';
        const API_URL_CHECK_TENANT = 'http://localhost:4000/api/check-tenant/'; 

        // Obtener token de autenticaciÃ³n y rol desde sessionStorage
        const authToken = sessionStorage.getItem('authToken');
        const userRol = sessionStorage.getItem('userRol');

        // VerificaciÃ³n de autenticaciÃ³n y rol
        if (!authToken || userRol !== 'super_admin') {
    alert('Acceso denegado o sesiÃ³n expirada. Redirigiendo al login.');
    sessionStorage.clear();
    window.location.href = 'login.html';
           }
           // FunciÃ³n para obtener headers con token de autenticaciÃ³n
       function getAuthHeaders() {
    return {
        'Content-Type': 'application/json',
        // ğŸ”‘ EnvÃ­a el token con el formato 'Bearer <token>'
        'Authorization': `Bearer ${authToken}` 
    };
}

// FunciÃ³n para manejar errores de autenticaciÃ³n    
        function handleAuthError(response) {
     if (response.status === 401 || response.status === 403) {
         alert('âš ï¸ SesiÃ³n expirada o permisos insuficientes. Por favor, inicie sesiÃ³n de nuevo.');
         sessionStorage.clear();
         window.location.href = 'login.html';
         return true;
     }
     return false; 
}

    // FunciÃ³n para cargar empresas
   async function loadEmpresas() {
    try {
        const loadingMsg = document.getElementById('loading-message');
        const table = document.getElementById('empresas-table');
        loadingMsg.style.display = 'block';
        table.style.display = 'none';

        const response = await fetch(API_URL_EMPRESAS, { 
            method: 'GET',
            headers: getAuthHeaders() 
        });
        
        if (handleAuthError(response)) return; 

        const result = await response.json();
        
        const tbody = document.getElementById('empresas-tbody');
        tbody.innerHTML = ''; 

        if (result.success && result.empresas.length > 0) {
            renderEmpresas(result.empresas); 
        } else {
            tbody.innerHTML = '<tr><td colspan="6">No hay empresas registradas.</td></tr>';
        }

        loadingMsg.style.display = 'none';
        table.style.display = 'table';

    } catch (error) {
        console.error('Error al cargar empresas:', error);
        document.getElementById('loading-message').textContent = 'Error al cargar los datos de las empresas.';
    }
}
        // FunciÃ³n para renderizar empresas en la tabla
function renderEmpresas(empresas) {
    const tbody = document.getElementById('empresas-tbody');
    tbody.innerHTML = ''; 

    empresas.forEach(empresa => {
        const tr = document.createElement('tr');
        
        const isSuperAdmin = empresa.tenant_id === 'super_admin';
        const adminEmail = empresa.admin_email || 'N/A'; 
        const fechaRegistro = new Date(empresa.fecha_registro).toLocaleDateString();

        tr.innerHTML = `
            <td>${empresa.id}</td>
            
            <td>${empresa.tenant_id}</td>
            
            <td>${empresa.nombre_empresa}</td>
            
            <td>${adminEmail}</td>
            
            <td>${empresa.activo ? 'Activo' : 'Suspendido'}</td>
            
            <td>${fechaRegistro}</td>
            
            <td>
                <button 
                    onclick="resetPassword('${empresa.tenant_id}', '${adminEmail}')" 
                    ${isSuperAdmin || adminEmail === 'N/A' ? 'disabled' : ''} 
                    title="Restablecer la contraseÃ±a del Administrador y forzar cambio.">
                    ğŸ”’ Reset ContraseÃ±a
                </button>
                <button onclick="sendInvite('${empresa.tenant_id}')" ${isSuperAdmin ? 'disabled' : ''}>ğŸ”— Invitar</button>
                <button onclick="gestionarEmpresa('${empresa.tenant_id}')">âš™ï¸ Gestionar</button>
                <button 
                    class="btn-delete"
                    onclick="deleteEmpresa('${empresa.tenant_id}', '${empresa.nombre_empresa}')"
                    ${isSuperAdmin ? 'disabled' : ''} 
                    title="${isSuperAdmin ? 'La empresa central no se puede eliminar.' : 'Eliminar puesto.'}">
                    ğŸ—‘ï¸ Eliminar
                </button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}
        //FunciÃ³n de enviar invitaciÃ³n
        function sendInvite(tenantId) {
            const inviteLink = `http://localhost:5500/frontend/login.html?tenant=${tenantId}`; 
            prompt(`Copie y envÃ­e este Tenant ID y el Enlace de InvitaciÃ³n:\n\nTenant ID: ${tenantId}\n\nEnlace:`, inviteLink);
        }
        

        //Funcion de crear empresa
        async function showCreateForm() {
            let tenant_id;
            
            while (true) {
                tenant_id = prompt("ID del Puesto/Empresa:");
                if (!tenant_id) return;
                
                if (tenant_id.toLowerCase() === 'super_admin') {
                    alert('Â¡Error! El Tenant ID "super_admin" estÃ¡ reservado.');
                    continue; 
                }

                try {
                    const response = await fetch(`${API_URL_CHECK_TENANT}${tenant_id}`);
                    const result = await response.json();

                    if (result.exists) {
                        alert(`Â¡Error de Duplicidad! El Tenant ID "${tenant_id}" ya estÃ¡ en uso. Por favor, ingrese uno diferente.`);
                    } else {
                        break; 
                    }
                } catch (e) {
                    alert('Error de conexiÃ³n al verificar el Tenant ID. Intente mÃ¡s tarde.');
                    return;
                }
            }
            
            const nombre_empresa = prompt(" Nombre de la Empresa:");
            if (!nombre_empresa) return;
            
            const nombre_admin = prompt(" Nombre COMPLETO del Administrador Inicial:");
            if (!nombre_admin) return;

            let correo_electronico;
            const emailRegex = /^[^\s@]+@(gmail\.com|outlook\.com|yahoo\.com|icloud\.com)$/i;

            while (true) {
                correo_electronico = prompt(" Correo del Admin Inicial (Solo dominios permitidos: @gmail.com, @outlook.com, @yahoo.com, @icloud.com):");
                
                if (!correo_electronico) return; 

                if (emailRegex.test(correo_electronico)) {
                    break; 
                } else {
                    alert('Â¡Error de Correo! El formato es invÃ¡lido o el dominio no estÃ¡ permitido. Intente de nuevo.');
                }
            }

            const password = prompt("ContraseÃ±a Temporal del Admin:");
            if (!password) return;
            
            const forzar_cambio_pw = confirm("Â¿Desea forzar al administrador a cambiar su contraseÃ±a al iniciar sesiÃ³n por primera vez?\n(Si cancela, usarÃ¡ la contraseÃ±a temporal permanentemente)");
            
            createEmpresa(tenant_id, nombre_empresa, nombre_admin, correo_electronico, password, forzar_cambio_pw); 
        }

 //Reestablecer contraseÃ±a mejorado
async function resetPassword(tenantId, adminEmail) {

    if (adminEmail === 'N/A') {
        alert("Error: No se pudo encontrar el correo del administrador para este puesto.");
        return;
    }
    
    
    const choice = prompt(
        ` Restablecer ContraseÃ±a para:\n\nPuesto ID: ${tenantId}\nCorreo: ${adminEmail}\n\nSeleccione una opciÃ³n:\n\n1) Generar una contraseÃ±a temporal ALEATORIA.\n2) Ingresar una contraseÃ±a temporal MANUALMENTE.`
    );

    if (choice === null) {
        alert("OperaciÃ³n de reseteo cancelada.");
        return;
    }
    
    let newTempPassword;

    if (choice === '1') {
        newTempPassword = 'GENERAR_ALEATORIA'; 
        alert("ContraseÃ±a aleatoria marcada para generaciÃ³n en el servidor. Presione OK para confirmar el envÃ­o por correo.");
        
    } else if (choice === '2') {
        newTempPassword = prompt(" Ingrese una ContraseÃ±a TEMPORAL (mÃ­nimo 6 caracteres):");

        if (!newTempPassword) {
            alert("OperaciÃ³n de reseteo cancelada.");
            return;
        }

        if (newTempPassword.length < 6) {
            alert("La contraseÃ±a temporal debe tener al menos 6 caracteres.");
            return;
        }
        
    } else {
        alert("OpciÃ³n invÃ¡lida. OperaciÃ³n cancelada.");
        return;
    }

    try {
        const response = await fetch(API_URL_ADMIN_RESET, {
            method: 'POST',
           headers: getAuthHeaders(), 
            body: JSON.stringify({ 
                tenant_id: tenantId,
                correo_electronico: adminEmail,
                new_password: newTempPassword
            })
        });

        const result = await response.json();

        if (response.ok && result.success) {
            const finalPassword = result.generatedPassword || newTempPassword; 
            
            alert(`âœ… Ã‰xito: ${result.message}\n\nSe ha enviado un correo al administrador.\n\nContraseÃ±a temporal usada: ${finalPassword}`);
            
            loadEmpresas(); 
        } else {
            alert('Error al resetear la contraseÃ±a: ' + (result.message || 'Error desconocido del servidor.'));
        }

    } catch (e) {
        alert('Error de conexiÃ³n con el servidor al intentar resetear la contraseÃ±a.');
    }
}
        //FunciÃ³n de crear empresa
        async function createEmpresa(tenant_id, nombre_empresa, nombre_admin, correo_electronico, password, forzar_cambio_pw) { Â 
            const data = { 
                tenant_id, 
                nombre_empresa, 
                nombre_admin, 
                correo_electronico, 
                password,
                forzar_cambio_pw
            };

            try {
                const response = await fetch(API_URL_REGISTER, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    alert(`Puesto/Empresa '${nombre_empresa}' creado exitosamente!`);
                    loadEmpresas(); 
                } else if (response.status === 409 || response.status === 400) { 
                    alert('Fallo de Registro: ' + (result.message || 'Error en la validaciÃ³n de datos.'));
                }
                else {
                    alert('Error al crear empresa: ' + (result.message || 'Error desconocido del servidor.'));
                }
            } catch (e) {
                alert('Error de conexiÃ³n con el servidor al crear empresa.');
            }
        }
        //FunciÃ³n de eliminar empresa
       async function deleteEmpresa(tenantId, nombreEmpresa) {
    if (!confirm(`Â¿EstÃ¡s seguro de ELIMINAR permanentemente la empresa "${nombreEmpresa}" (ID: ${tenantId}) y todos sus datos?`)) {
        return; 
    }

    try {
        const response = await fetch(`http://localhost:4000/api/empresa/${tenantId}`, { 
            method: 'DELETE',
            headers: getAuthHeaders(), 
        });

        if (handleAuthError(response)) return; 
        
        const result = await response.json();

        if (response.ok && result.success) {
            alert(result.message);
            loadEmpresas(); 
        } else {
            alert('Error al eliminar: ' + (result.message || 'Error desconocido.'));
        }
    } catch (e) {
        alert('Error de conexiÃ³n con el servidor al intentar eliminar.');
    }
}

        loadEmpresas(); 
    </script>
</body>
</html>